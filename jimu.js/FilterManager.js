// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt and http://www.arcgis.com/apps/webappbuilder/copyright.txt for details.
//>>built
define(["dojo/_base/declare","dojo/_base/lang","dojo/topic","esri/lang","./LayerInfos/LayerInfos"],function(m,d,f,n,l){var g=null,k=m(null,{_filters:null,layerInfos:null,constructor:function(){this._filters={};window.isBuilder?(f.subscribe("app/mapLoaded",d.hitch(this,this._onMapLoaded)),f.subscribe("app/mapChanged",d.hitch(this,this._onMapChanged))):(f.subscribe("mapLoaded",d.hitch(this,this._onMapLoaded)),f.subscribe("mapChanged",d.hitch(this,this._onMapChanged)));f.subscribe("widgetDestroyed",
d.hitch(this,this._onWidgetDestroyed))},getWidgetFilter:function(a,b){return d.getObject(a+".filterExprs."+b,!1,this._filters)},applyWidgetFilter:function(a,b,c,e,d){this._setFilterExp(a,b,c,e,d);b=this.layerInfos.getLayerInfoById(a)||this.layerInfos.getTableInfoById(a);a=this._getFilterExp(a);null!==a&&b&&b.setFilter(a)},_onMapLoaded:function(){this.layerInfos=l.getInstanceSync();this._traversalFilter()},_onMapChanged:function(){this.layerInfos=l.getInstanceSync();this._traversalFilter()},_onWidgetDestroyed:function(a){for(var b in this._filters)if(this._filters[b]){var c=
this._filters[b];if(c){var e=c.filterExprs,c=c.mapFilterControls;e&&delete e[a];c&&delete c[a]}}},_traversalFilter:function(){this.layerInfos.traversalAll(d.hitch(this,function(a){this._filters[a.id]||(this._filters[a.id]={definitionExpression:a.getFilter(),filterExprs:{},mapFilterControls:{}})}))},_getPriorityOfMapFilter:function(a){a=d.getObject(a+".mapFilterControls",!1,this._filters);var b=0,c;for(c in a){var e=a[c];e.priority>b&&(b=e.priority)}return b},_getMapFilterControl:function(a){a=d.getObject(a+
".mapFilterControls",!1,this._filters);var b=0,c=null,e;for(e in a){var h=a[e];h.priority>b&&(b=h.priority,c=h)}return c},_setFilterExp:function(a,b,c,e,h){var f=a+".filterExprs."+b,g=a+".mapFilterControls."+b;c?(d.setObject(f,c,this._filters),n.isDefined(e)&&(a=this._getPriorityOfMapFilter(a),d.setObject(g,{enable:e,useAND:h,priority:a+1},this._filters))):(d.getObject(f,!1,this._filters)&&delete this._filters[a].filterExprs[b],d.getObject(g,!1,this._filters)&&delete this._filters[a].mapFilterControls[b])},
_getFilterExp:function(a){if(!this._filters[a])return null;var b=[],c=this._filters[a].definitionExpression,e=this._filters[a].filterExprs;a=this._getMapFilterControl(a);for(var d in e){var f=e[d];f&&b.push("("+f+")")}b=b.join(" AND ");return c&&a&&a.enable||c&&null===a?b?a&&!1===a.useAND?"("+c+") OR "+b:"("+c+") AND "+b:c:b}});k.getInstance=function(){if(null===g)g=new k,window._filterManager=g;else return g};return k});